name: Deploy to Cloud Run

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.GCP_REGION }}
  REPO_NAME: pfc-services

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Google Auth
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker
      run: gcloud auth configure-docker $REGION-docker.pkg.dev

    # 1. Build and Deploy Python Service
    - name: Build Python Image
      run: |
        docker build -t $REGION-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/python-model:${{ github.sha }} ./python-model
        docker push $REGION-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/python-model:${{ github.sha }}

    - name: Deploy Python Service
      run: |
        gcloud run deploy pfc-python-model \
          --image $REGION-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/python-model:${{ github.sha }} \
          --region $REGION \
          --platform managed \
          --allow-unauthenticated \
          --memory 1Gi \
          --set-env-vars "NUM_SIMULATIONS=10000,FORECAST_HOURS=24"

    - name: Get Python Service URL
      id: python-url
      run: |
        url=$(gcloud run services describe pfc-python-model --region $REGION --format 'value(status.url)')
        echo "url=$url" >> $GITHUB_OUTPUT

    # 2. Build and Deploy Go API
    - name: Build Go Image
      run: |
        docker build -t $REGION-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/go-api:${{ github.sha }} ./go-api
        docker push $REGION-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/go-api:${{ github.sha }}

    - name: Deploy Go API
      run: |
        gcloud run deploy pfc-go-api \
          --image $REGION-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/go-api:${{ github.sha }} \
          --region $REGION \
          --platform managed \
          --allow-unauthenticated \
          --memory 512Mi \
          --set-env-vars "PYTHON_SERVICE_URL=${{ steps.python-url.outputs.url }},FIRESTORE_PROJECT_ID=$PROJECT_ID" \
          --set-secrets "ALPHA_VANTAGE_KEY=alpha-vantage-key:latest"

    - name: Show Deployment URLs
      run: |
        echo "Python Service: ${{ steps.python-url.outputs.url }}"
        echo "Go API: $(gcloud run services describe pfc-go-api --region $REGION --format 'value(status.url)')"
